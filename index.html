# -*- coding: utf-8 -*-
"""
Created on Fri Jul 25 12:03:04 2025

@author: user
"""

# Step 2: Basic Flask Application
# File: app.py

"""
AI Todo App - Basic Flask Setup
This is the main application file for our AI-powered Todo app.
We'll start simple and build it step by step.
"""

# Import required libraries
from flask import Flask, jsonify, request, render_template
from flask_sqlalchemy import SQLAlchemy
from flask_cors import CORS
from datetime import datetime
import os
from openai import OpenAI

# Create Flask application
app = Flask(__name__)

# Enable CORS (Cross-Origin Resource Sharing) for API access
CORS(app)

# Initialize OpenAI client
openai_client = OpenAI(api_key=os.environ.get('OPENAI_API_KEY'))

# Database configuration
# For now, we'll use SQLite (simple file-based database)
app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///todos.db'
app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False

# Initialize database
db = SQLAlchemy(app)

# Create a simple Todo model (database table structure)
class Todo(db.Model):
    """
    Todo model - represents a single todo item in our database
    """
    id = db.Column(db.Integer, primary_key=True)  # Unique ID for each todo
    text = db.Column(db.String(500), nullable=False)  # The todo text (max 500 chars)
    completed = db.Column(db.Boolean, default=False)  # Is it completed?
    created_at = db.Column(db.DateTime, default=datetime.utcnow)  # When was it created?
    
    def to_dict(self):
        """Convert Todo object to dictionary (for JSON responses)"""
        return {
            'id': self.id,
            'text': self.text,
            'completed': self.completed,
            'created_at': self.created_at.isoformat() if self.created_at else None
        }

# Basic Routes (URL endpoints)

@app.route('/')
def home():
    """
    Home page route - serves our HTML todo app
    """
    return render_template('index.html')

@app.route('/index.html')
def index():
    """
    Alternative route for index.html
    """
    return render_template('index.html')

@app.route('/api/todos', methods=['GET'])
def get_todos():
    """
    API endpoint to get all todos
    Returns JSON list of all todos
    """
    try:
        # Get all todos from database, ordered by newest first
        todos = Todo.query.order_by(Todo.created_at.desc()).all()
        
        # Convert to list of dictionaries
        todos_list = [todo.to_dict() for todo in todos]
        
        return jsonify({
            'success': True,
            'todos': todos_list,
            'count': len(todos_list)
        })
    except Exception as e:
        return jsonify({
            'success': False,
            'error': str(e)
        }), 500

@app.route('/api/todos', methods=['POST'])
def create_todo():
    """
    API endpoint to create a new todo
    Expects JSON: {"text": "Your todo text"}
    """
    try:
        # Get JSON data from request
        data = request.get_json()
        
        # Validate input
        if not data or not data.get('text'):
            return jsonify({
                'success': False,
                'error': 'Todo text is required'
            }), 400
        
        # Create new todo
        todo = Todo(text=data['text'].strip())
        
        # Save to database
        db.session.add(todo)
        db.session.commit()
        
        return jsonify({
            'success': True,
            'todo': todo.to_dict(),
            'message': 'Todo created successfully!'
        }), 201
        
    except Exception as e:
        db.session.rollback()
        return jsonify({
            'success': False,
            'error': str(e)
        }), 500

@app.route('/api/todos/<int:todo_id>', methods=['PUT'])
def update_todo(todo_id):
    """
    API endpoint to update a todo (mark as completed/uncompleted)
    Expects JSON: {"completed": true/false}
    """
    try:
        # Find the todo
        todo = Todo.query.get(todo_id)
        if not todo:
            return jsonify({
                'success': False,
                'error': 'Todo not found'
            }), 404
        
        # Get update data
        data = request.get_json()
        if not data:
            return jsonify({
                'success': False,
                'error': 'No data provided'
            }), 400
        
        # Update completion status
        if 'completed' in data:
            todo.completed = bool(data['completed'])
        
        # Update text if provided
        if 'text' in data:
            todo.text = data['text'].strip()
        
        # Save changes
        db.session.commit()
        
        return jsonify({
            'success': True,
            'todo': todo.to_dict(),
            'message': 'Todo updated successfully!'
        })
        
    except Exception as e:
        db.session.rollback()
        return jsonify({
            'success': False,
            'error': str(e)
        }), 500

@app.route('/api/translate', methods=['POST'])
def translate_text():
    """
    API endpoint to translate text using OpenAI
    Expects JSON: {"text": "text to translate", "target_language": "Spanish"}
    """
    try:
        # Get JSON data from request
        data = request.get_json()
        
        # Validate input
        if not data or not data.get('text') or not data.get('target_language'):
            return jsonify({
                'success': False,
                'error': 'Text and target_language are required'
            }), 400
        
        text_to_translate = data['text'].strip()
        target_language = data['target_language'].strip()
        
        # Call OpenAI API for translation
        response = openai_client.chat.completions.create(
            model="gpt-3.5-turbo",
            messages=[
                {
                    "role": "system",
                    "content": "You are a professional translator. Translate the given text accurately to the target language. Return only the translation, no explanations."
                },
                {
                    "role": "user",
                    "content": f"Translate this text to {target_language}: \"{text_to_translate}\""
                }
            ],
            max_tokens=200,
            temperature=0.3
        )
        
        # Extract translation from response
        translation = response.choices[0].message.content.strip()
        
        return jsonify({
            'success': True,
            'original_text': text_to_translate,
            'translated_text': translation,
            'target_language': target_language
        })
        
    except Exception as e:
        return jsonify({
            'success': False,
            'error': f'Translation failed: {str(e)}'
        }), 500

# Initialize database when app starts
def init_database():
    """Create database tables if they don't exist"""
    with app.app_context():
        db.create_all()
        print("‚úÖ Database initialized successfully!")

# Run the application
if __name__ == '__main__':
    # Initialize database
    init_database()
    
    # Start the Flask development server
    print("üöÄ Starting AI Todo App...")
    print("üìç Open your browser and go to: http://localhost:5000")
    
    try:
        # Run in debug mode for development
        app.run(debug=False, host='127.0.0.1', port=5000, use_reloader=False)
    except Exception as e:
        print(f"Error starting app: {e}")
